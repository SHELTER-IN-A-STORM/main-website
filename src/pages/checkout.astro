---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { format } from 'date-fns';

// Get event details from content collection
const events = await getCollection('events');
const fallFundraiser = events.find(event => event.slug === '4');

const eventConfig = {
    name: "2nd Annual Fall Fundraiser",
    date: "Saturday, November 1, 2025",
    time: "5:00 PM - 8:00 PM",
    location: "Memory Lane Events, 78 Walnut Grove Road, Eldon, MO",
    price: 50, // $50 per ticket
    maxTickets: 5
};

// Stripe API configuration
const STRIPE_API_URL = 'https://api.shelterinastorm.org/api/v2/OtherProduct';
---

<Layout title="2nd Annual Fall Fundraiser - Tickets & Sponsorship">
    <!-- Hero Section -->
    <section class="relative min-h-screen flex items-center justify-center">
        <div class="absolute inset-0">
            <img 
                src="https://cdn.shelterinastorm.org/images/2025-FallFundraiser-Front-1.png"
                alt="2nd Annual Fall Fundraiser"
                class="w-full h-full object-cover"
            />
            <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/40 to-black/60"></div>
        </div>

        <div class="container mx-auto px-6 relative z-10">
            <div class="max-w-4xl mx-auto text-center text-white space-y-8">
                <h1 
                    class="text-5xl md:text-7xl font-bold mb-6"
                    style="text-wrap: balance;"
                >
                    2nd Annual Fall Fundraiser
                </h1>
                <p 
                    class="text-xl md:text-2xl text-gray-200 mb-12 max-w-2xl mx-auto"
                    style="text-wrap: balance;"
                >
                    Join us for dinner, bake-off competition, live music, and silent auction!
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center items-center mb-8">
                    <div class="bg-white/10 backdrop-blur-sm rounded-lg px-6 py-3">
                        <div class="text-sm text-gray-300">Date</div>
                        <div class="font-semibold">November 1, 2025</div>
                    </div>
                    <div class="bg-white/10 backdrop-blur-sm rounded-lg px-6 py-3">
                        <div class="text-sm text-gray-300">Time</div>
                        <div class="font-semibold">5:00 PM - 8:00 PM</div>
                    </div>
                    <div class="bg-white/10 backdrop-blur-sm rounded-lg px-6 py-3">
                        <div class="text-sm text-gray-300">Location</div>
                        <div class="font-semibold">Memory Lane Events</div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                    <a 
                        href="#tickets" 
                        class="inline-flex items-center gap-2 bg-brand hover:bg-brand-dark text-white px-8 py-4 rounded-lg font-semibold transition-colors text-lg shadow-lg hover:shadow-xl"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                        </svg>
                        Get Tickets
                    </a>
                    <a 
                        href="#tickets" 
                        class="inline-flex items-center gap-2 bg-white/20 hover:bg-white/30 text-white px-8 py-4 rounded-lg font-semibold transition-colors text-lg backdrop-blur-sm border border-white/30"
                    >
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                        Become a Sponsor
                    </a>
                </div>
            </div>
        </div>
    </section>

    <!-- Event Details Section -->
    <section id="details" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">Event Details</h2>
                    <p class="text-lg text-gray-600 mb-8">Join us for our exciting Fall Fundraiser featuring dinner, bake-off competition, live music, and silent auction! All proceeds will benefit Shelter in a Storm.</p>
                    
                    <!-- Quick Navigation -->
                    <div class="flex flex-wrap justify-center gap-4">
                        <a href="#details" class="inline-flex items-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                            Event Details
                        </a>
                        <a href="#tickets" class="inline-flex items-center gap-2 bg-brand hover:bg-brand-dark text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                            </svg>
                            Get Tickets
                        </a>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-12">
                    <!-- Event Schedule -->
                    <div class="bg-gray-50 rounded-xl p-8">
                        <h3 class="text-2xl font-bold text-gray-900 mb-6">Event Schedule</h3>
                        <div class="space-y-4">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-brand text-white rounded-full flex items-center justify-center font-bold">5:00</div>
                                <div>
                                    <div class="font-semibold text-gray-900">Cash Bar Opens</div>
                                    <div class="text-gray-600">Refreshments available</div>
                            </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-brand text-white rounded-full flex items-center justify-center font-bold">6:00</div>
                                <div>
                                    <div class="font-semibold text-gray-900">Dinner & Bake-off Tasting</div>
                                    <div class="text-gray-600">Enjoy a delicious meal and vote for your favorites</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-brand text-white rounded-full flex items-center justify-center font-bold">7:15</div>
                                <div>
                                    <div class="font-semibold text-gray-900">Bake-off Trophy Awarded</div>
                                    <div class="text-gray-600">Winner announced</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- What to Expect -->
                    <div class="bg-gray-50 rounded-xl p-8">
                        <h3 class="text-2xl font-bold text-gray-900 mb-6">What to Expect</h3>
                        <div class="space-y-4">
                            <div class="flex items-start gap-3">
                                <svg class="w-6 h-6 text-brand mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                                <div>
                                    <div class="font-semibold text-gray-900">Dinner</div>
                                    <div class="text-gray-600">Enjoy a delicious meal</div>
                    </div>
                </div>
                            <div class="flex items-start gap-3">
                                <svg class="w-6 h-6 text-brand mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                <div>
                                    <div class="font-semibold text-gray-900">Bake-off Competition</div>
                                    <div class="text-gray-600">Taste amazing baked goods and vote for your favorites</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="w-6 h-6 text-brand mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                <div>
                                    <div class="font-semibold text-gray-900">Live Music</div>
                                    <div class="text-gray-600">Enjoy "Me & Jim" pick their guitars to 60s & 70s music</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="w-6 h-6 text-brand mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                <div>
                                    <div class="font-semibold text-gray-900">Silent Auction</div>
                                    <div class="text-gray-600">Bid on unique items and experiences</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>



    <!-- Checkout Section -->
    <section id="tickets" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold text-gray-900 mb-4">Get Your Tickets</h2>
                    <p class="text-lg text-gray-600">Choose from regular admission tickets, sponsor packages, drawing entries, and more!</p>
                </div>

                <!-- Professional Checkout Container -->
                <form id="checkoutForm" class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
                    <!-- Checkout Options -->
                    <div class="p-8">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Choose Your Support</h2>
                            <p class="text-gray-600">Select how you'd like to support our Fall Fundraiser</p>
                        </div>

                        <div class="grid md:grid-cols-3 gap-6 max-w-4xl mx-auto mb-8">
                            <!-- Buy Tickets Option -->
                            <div class="intent-option p-6 border-2 border-gray-200 rounded-xl hover:border-brand hover:bg-brand/5 transition-all duration-200 text-left group cursor-pointer" data-intent="tickets">
                                <div class="text-center">
                                    <div class="w-16 h-16 bg-brand/10 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-brand/20 transition-colors">
                                        <svg class="w-8 h-8 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/>
                                        </svg>
                                    </div>
                                    <h3 class="font-semibold text-gray-900 mb-2">Buy Tickets</h3>
                                    <p class="text-sm text-gray-600 mb-3">Purchase admission tickets for the event</p>
                                    <div class="text-lg font-bold text-brand">$50 per person</div>
                                </div>
                            </div>

                            <!-- Become Sponsor Option -->
                            <div class="intent-option p-6 border-2 border-gray-200 rounded-xl hover:border-brand hover:bg-brand/5 transition-all duration-200 text-left group cursor-pointer" data-intent="sponsor">
                                <div class="text-center">
                                    <div class="w-16 h-16 bg-brand/10 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-brand/20 transition-colors">
                                        <svg class="w-8 h-8 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                        </svg>
                                    </div>
                                    <h3 class="font-semibold text-gray-900 mb-2">Become a Sponsor</h3>
                                    <p class="text-sm text-gray-600 mb-3">Support the event with a sponsor package</p>
                                    <div class="text-lg font-bold text-brand">$500 - $2,000</div>
                                </div>
                            </div>

                            <!-- Make Donation Option -->
                            <div class="intent-option p-6 border-2 border-gray-200 rounded-xl hover:border-brand hover:bg-brand/5 transition-all duration-200 text-left group cursor-pointer" data-intent="donation">
                                <div class="text-center">
                                    <div class="w-16 h-16 bg-brand/10 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-brand/20 transition-colors">
                                        <svg class="w-8 h-8 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                        </svg>
                                    </div>
                                    <h3 class="font-semibold text-gray-900 mb-2">Make a Donation</h3>
                                    <p class="text-sm text-gray-600 mb-3">Support our cause with a tax-deductible donation</p>
                                    <div class="text-lg font-bold text-brand">Any amount</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Buy Tickets Flow -->
                    <div class="checkout-step p-8 hidden" data-step="2" data-flow="tickets">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Buy Tickets</h2>
                            <p class="text-gray-600">Purchase admission tickets for the Fall Fundraiser</p>
                        </div>

                        <!-- Contact Information -->
                        <div class="bg-gray-50 rounded-xl p-6 mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Contact Information</h3>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                                    <input 
                                        type="email" 
                                        id="email" 
                                        name="email" 
                                        required 
                                        class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-brand focus:border-brand"
                                        placeholder="your@email.com"
                                    >
                                </div>
                                <div>
                                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                    <input 
                                        type="tel" 
                                        id="phone" 
                                        name="phone" 
                                        class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-brand focus:border-brand"
                                        placeholder="(555) 123-4567"
                                    >
                                </div>
                            </div>
                        </div>

                        <!-- Ticket Selection -->
                        <div class="border border-gray-200 rounded-xl p-6 mb-6">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-1">Regular Admission</h3>
                                    <p class="text-gray-600 mb-2">Includes dinner, bake-off tasting, and all activities</p>
                                    <p class="text-2xl font-bold text-brand">$50 <span class="text-sm font-normal text-gray-600">per person</span></p>
                                </div>
                                <div class="flex items-center gap-4">
                                    <button type="button" class="quantity-btn w-12 h-12 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors text-xl font-bold" data-action="decrease" data-type="regular">-</button>
                                    <span class="quantity-display w-16 text-center font-semibold text-2xl min-w-[4rem]" data-type="regular">0</span>
                                    <button type="button" class="quantity-btn w-12 h-12 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors text-xl font-bold" data-action="increase" data-type="regular">+</button>
                                </div>
                            </div>
                        </div>

                        <!-- Sponsor Suggestion (appears when 4+ tickets) -->
                        <div id="sponsor-suggestion" class="hidden bg-blue-50 border border-blue-200 rounded-xl p-6 mb-6">
                            <div class="flex items-start gap-4">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-blue-900 mb-2">Consider Becoming a Sponsor!</h4>
                                    <p class="text-blue-800 mb-3">You're buying <span id="suggestion-ticket-count">4</span> tickets. A sponsor package might be more cost-effective and includes recognition benefits.</p>
                                    <button type="button" class="btn-switch-to-sponsor bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                        View Sponsor Packages →
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Drawing Entries -->
                        <div class="border border-gray-200 rounded-xl p-6 mb-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Add Drawing Entries (Optional)</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div>
                                        <div class="font-semibold text-gray-900">Drawing Entries</div>
                                        <div class="text-sm text-gray-600">$10 each • Buy 3+ and save with our triple package deal!</div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <button type="button" class="quantity-btn w-8 h-8 bg-white hover:bg-gray-100 rounded-full flex items-center justify-center transition-colors font-bold" data-action="decrease" data-type="raffle-total">-</button>
                                        <span class="quantity-display w-12 text-center font-semibold min-w-[3rem]" data-type="raffle-total">0</span>
                                        <button type="button" class="quantity-btn w-8 h-8 bg-white hover:bg-gray-100 rounded-full flex items-center justify-center transition-colors font-bold" data-action="increase" data-type="raffle-total">+</button>
                                    </div>
                                </div>
                                
                                <!-- Smart Pricing Display -->
                                <div id="raffle-pricing-breakdown" class="hidden bg-green-50 border border-green-200 rounded-lg p-4">
                                    <div class="flex items-center gap-2 mb-2">
                                        <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <span class="font-semibold text-green-800">Smart Pricing Applied!</span>
                                    </div>
                                    <div id="raffle-breakdown-text" class="text-sm text-green-700"></div>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mt-3">Maximum 50 drawing entries per person</p>
                        </div>

                        <!-- Additional Options -->
                        <div class="space-y-4 mb-8">
                            <label class="flex items-start space-x-3 cursor-pointer p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                <input type="checkbox" name="bakeOff" class="mt-1 w-4 h-4 text-brand border-gray-300 rounded focus:ring-brand">
                                <div>
                                    <div class="font-medium text-gray-900">Enter Bake-Off Competition</div>
                                    <div class="text-sm text-gray-600">Bring 48 homemade mini cupcakes or mini cheesecakes</div>
                                </div>
                            </label>
                            <label class="flex items-start space-x-3 cursor-pointer p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                <input type="checkbox" name="coverFees" class="mt-1 w-4 h-4 text-brand border-gray-300 rounded focus:ring-brand">
                                <div>
                                    <div class="font-medium text-gray-900">Cover Processing Fees</div>
                                    <div class="text-sm text-gray-600">Help us maximize funds for our cause</div>
                                </div>
                            </label>
                        </div>

                        <div class="flex justify-center">
                            <button type="button" class="btn-next bg-brand hover:bg-brand-dark text-white px-8 py-4 rounded-lg font-semibold transition-colors text-lg">
                                Continue to Payment →
                            </button>
                        </div>
                    </div>

                    <!-- Sponsor Flow -->
                    <div class="checkout-step p-8 hidden" data-step="2" data-flow="sponsor">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Become a Sponsor</h2>
                            <p class="text-gray-600">Support the event with a sponsor package and get recognition</p>
                        </div>

                        <!-- Contact Information -->
                        <div class="bg-gray-50 rounded-xl p-6 mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Contact Information</h3>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label for="sponsor-email" class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                                    <input 
                                        type="email" 
                                        id="sponsor-email" 
                                        name="sponsor-email" 
                                        required 
                                        class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-brand focus:border-brand"
                                        placeholder="your@email.com"
                                    >
                                </div>
                                <div>
                                    <label for="sponsor-phone" class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                    <input 
                                        type="tel" 
                                        id="sponsor-phone" 
                                        name="sponsor-phone" 
                                        class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-brand focus:border-brand"
                                        placeholder="(555) 123-4567"
                                    >
                                </div>
                            </div>
                        </div>

                        <!-- Sponsor Package Selection -->
                        <div class="grid md:grid-cols-3 gap-6 mb-8">
                            <label class="sponsor-option p-6 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-brand hover:bg-brand/5 transition-all">
                                <input type="radio" name="sponsor" value="bronze" class="sr-only">
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-brand mb-2">$500</div>
                                    <div class="font-semibold text-gray-900 mb-2">Bronze Sponsor</div>
                                    <div class="text-sm text-gray-600 mb-4">2 people + Logo/Name on materials</div>
                                    <div class="text-xs text-gray-500">Perfect for small businesses</div>
                                </div>
                            </label>
                            <label class="sponsor-option p-6 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-brand hover:bg-brand/5 transition-all">
                                <input type="radio" name="sponsor" value="silver" class="sr-only">
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-brand mb-2">$1,000</div>
                                    <div class="font-semibold text-gray-900 mb-2">Silver Sponsor</div>
                                    <div class="text-sm text-gray-600 mb-4">4 people + Logo/Name on materials</div>
                                    <div class="text-xs text-gray-500">Great for medium businesses</div>
                                </div>
                            </label>
                            <label class="sponsor-option p-6 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-brand hover:bg-brand/5 transition-all">
                                <input type="radio" name="sponsor" value="gold" class="sr-only">
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-brand mb-2">$2,000</div>
                                    <div class="font-semibold text-gray-900 mb-2">Gold Sponsor</div>
                                    <div class="text-sm text-gray-600 mb-4">8 people + Logo/Name on materials</div>
                                    <div class="text-xs text-gray-500">Premium visibility</div>
                                </div>
                            </label>
                        </div>

                        <!-- Additional Tickets for Sponsors -->
                        <div class="border border-gray-200 rounded-xl p-6 mb-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Additional Admission Tickets</h3>
                            <p class="text-gray-600 mb-4">Need more tickets beyond your sponsor package? Add them here.</p>
                            
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-900 mb-1">Extra Admission Tickets</div>
                                    <p class="text-gray-600 mb-2">Additional tickets for your team or guests</p>
                                    <p class="text-2xl font-bold text-brand">$50 <span class="text-sm font-normal text-gray-600">per person</span></p>
                                </div>
                                <div class="flex items-center gap-4">
                                    <button type="button" class="quantity-btn w-12 h-12 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors text-xl font-bold" data-action="decrease" data-type="sponsor-extra">-</button>
                                    <span class="quantity-display w-16 text-center font-semibold text-2xl min-w-[4rem]" data-type="sponsor-extra">0</span>
                                    <button type="button" class="quantity-btn w-12 h-12 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors text-xl font-bold" data-action="increase" data-type="sponsor-extra">+</button>
                                </div>
                            </div>
                        </div>

                        <!-- Sponsor Benefits -->
                        <div class="bg-green-50 border border-green-200 rounded-xl p-6 mb-8">
                            <h3 class="text-lg font-semibold text-green-900 mb-4">Sponsor Benefits</h3>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="flex items-center gap-3">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    <span class="text-green-800">Logo/Name on event materials</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    <span class="text-green-800">Admission for multiple people</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    <span class="text-green-800">Dinner and bake-off tasting</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    <span class="text-green-800">Tax-deductible contribution</span>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-center">
                            <button type="button" class="btn-next bg-brand hover:bg-brand-dark text-white px-8 py-4 rounded-lg font-semibold transition-colors text-lg">
                                Continue to Payment →
                            </button>
                        </div>
                    </div>

                    <!-- Review & Payment -->
                    <div class="checkout-step p-8 hidden" data-step="3">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Review & Payment</h2>
                            <p class="text-gray-600">Review your order and complete your purchase</p>
                        </div>

                        <div class="grid lg:grid-cols-2 gap-8">
                            <!-- Order Summary -->
                            <div class="space-y-6">
                                <div class="bg-gray-50 rounded-xl p-6">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Order Summary</h3>
                                    <div id="orderSummary" class="space-y-3">
                                        <!-- Order items will be populated here -->
                                    </div>
                                    <div class="border-t border-gray-300 pt-4 mt-4">
                                        <div class="flex justify-between text-xl font-bold">
                                            <span>Total:</span>
                                            <span id="totalAmount" class="text-brand">$0.00</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Important Documents -->
                                <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
                                    <h3 class="text-lg font-semibold text-blue-900 mb-4">Important Documents</h3>
                                    <div class="space-y-3">
                                        <a 
                                            href="https://app.box.com/s/2c461qyql0cai1lxu4hb2xv21nbh4uxi" 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            class="flex items-center gap-3 text-blue-700 hover:text-blue-800 transition-colors"
                                        >
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                            </svg>
                                            <span>Official Prize Rules (PDF)</span>
                                        </a>
                                        <a 
                                            href="https://app.box.com/s/95tz5hmqf1cptuea1ttd249pteyik2qf" 
                                            target="_blank" 
                                            rel="noopener noreferrer"
                                            class="flex items-center gap-3 text-blue-700 hover:text-blue-800 transition-colors"
                                        >
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                            </svg>
                                            <span>Ticket Refund Policy (PDF)</span>
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Section -->
                            <div class="space-y-6">
                                <div class="bg-gray-50 rounded-xl p-6">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Payment Information</h3>
                                    <div class="space-y-4">
                                        <div class="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200">
                                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                                            </svg>
                                            <div>
                                                <div class="font-medium text-gray-900">Secure Payment</div>
                                                <div class="text-sm text-gray-600">You'll be redirected to our secure payment processor</div>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200">
                                            <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            <div>
                                                <div class="font-medium text-gray-900">Tax-Deductible</div>
                                                <div class="text-sm text-gray-600">Your purchase supports our 501(c)(3) nonprofit</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Payment Button -->
                                <button type="submit" id="payButton" class="w-full bg-brand hover:bg-brand-dark text-white py-4 rounded-xl font-semibold text-lg transition-colors flex items-center justify-center gap-3 shadow-lg hover:shadow-xl">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                                    </svg>
                                    Complete Purchase
                                </button>
                            </div>
                        </div>

                        <div class="mt-8 text-center">
                            <button type="button" class="btn-prev bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                                ← Back to Options
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Error Message -->
                <div id="errorMessage" class="mt-6 bg-red-50 border border-red-200 rounded-xl p-4 hidden">
                    <div class="flex">
                        <svg class="w-5 h-5 text-red-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div class="ml-3">
                            <p class="text-sm text-red-800" id="errorText"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</Layout>

<script>
    // Event configuration
    const eventConfig = {
        name: "2nd Annual Fall Fundraiser",
        date: "Saturday, November 1, 2025",
        time: "5:00 PM - 8:00 PM",
        location: "Memory Lane Events, 78 Walnut Grove Road, Eldon, MO",
        price: 50
    };

    // Pricing configuration
    const pricing = {
        regularTicket: 50,
        goldSponsor: 2000,
        silverSponsor: 1000,
        bronzeSponsor: 500,
        raffleSingle: 10,
        raffleTriple: 20
    };

    // API configuration
    const STRIPE_API_URL = 'https://api.shelterinastorm.org/api/v2/OtherProduct';

    // State management
    let currentStep = 1;
    let userIntent: 'tickets' | 'sponsor' | 'donation' | null = null;
    let orderState = {
        email: '',
        phone: '',
        regularTickets: 0,
        sponsorPackage: null as string | null,
        sponsorExtraTickets: 0,
        raffleTotal: 0,
        raffleTriplePackages: 0,
        raffleSingleTickets: 0,
        bakeOffEntry: false,
        payProcessingFees: false,
        donationOnly: false,
        donationAmount: 0
    };

    // DOM elements
    const form = document.getElementById('checkoutForm');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const payButton = document.getElementById('payButton') as HTMLButtonElement;
    const orderSummary = document.getElementById('orderSummary');
    const totalAmount = document.getElementById('totalAmount');

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        setupEventListeners();
    });

    function setupEventListeners() {
        // Intent selection
        document.querySelectorAll('.intent-option').forEach(btn => {
            btn.addEventListener('click', handleIntentSelection);
        });

        // Step navigation
        document.querySelectorAll('.btn-next').forEach(btn => {
            btn.addEventListener('click', nextStep);
        });
        
        document.querySelectorAll('.btn-prev').forEach(btn => {
            btn.addEventListener('click', prevStep);
        });

        // Quantity buttons
        document.querySelectorAll('.quantity-btn').forEach(btn => {
            btn.addEventListener('click', handleQuantityChange);
        });

        // Sponsor option selection
        document.querySelectorAll('.sponsor-option').forEach(option => {
            option.addEventListener('click', handleSponsorSelection);
        });

        // Switch to sponsor flow button
        const switchToSponsorBtn = document.querySelector('.btn-switch-to-sponsor');
        if (switchToSponsorBtn) {
            switchToSponsorBtn.addEventListener('click', switchToSponsorFlow);
        }

        // Form inputs
        const emailInput = document.getElementById('email') as HTMLInputElement;
        const phoneInput = document.getElementById('phone') as HTMLInputElement;
        const sponsorEmailInput = document.getElementById('sponsor-email') as HTMLInputElement;
        const sponsorPhoneInput = document.getElementById('sponsor-phone') as HTMLInputElement;
        
        if (emailInput) {
            emailInput.addEventListener('input', (e) => {
                orderState.email = (e.target as HTMLInputElement).value;
            });
        }

        if (phoneInput) {
            phoneInput.addEventListener('input', (e) => {
                orderState.phone = (e.target as HTMLInputElement).value;
            });
        }

        if (sponsorEmailInput) {
            sponsorEmailInput.addEventListener('input', (e) => {
                orderState.email = (e.target as HTMLInputElement).value;
            });
        }

        if (sponsorPhoneInput) {
            sponsorPhoneInput.addEventListener('input', (e) => {
                orderState.phone = (e.target as HTMLInputElement).value;
            });
        }

        // Sponsor packages
        document.querySelectorAll('input[name="sponsor"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                orderState.sponsorPackage = (e.target as HTMLInputElement).value || null;
                updateOrderSummary();
            });
        });

        // Checkboxes
        const bakeOffCheckbox = document.querySelector('input[name="bakeOff"]') as HTMLInputElement;
        const coverFeesCheckbox = document.querySelector('input[name="coverFees"]') as HTMLInputElement;
        const donationOnlyCheckbox = document.querySelector('input[name="donationOnly"]') as HTMLInputElement;
        const donationAmountInput = document.querySelector('input[name="donationAmount"]') as HTMLInputElement;

        if (bakeOffCheckbox) {
            bakeOffCheckbox.addEventListener('change', (e) => {
                orderState.bakeOffEntry = (e.target as HTMLInputElement).checked;
            });
        }

        if (coverFeesCheckbox) {
            coverFeesCheckbox.addEventListener('change', (e) => {
                orderState.payProcessingFees = (e.target as HTMLInputElement).checked;
                updateOrderSummary();
            });
        }

        if (donationOnlyCheckbox) {
            donationOnlyCheckbox.addEventListener('change', (e) => {
                orderState.donationOnly = (e.target as HTMLInputElement).checked;
                updateOrderSummary();
            });
        }

        if (donationAmountInput) {
            donationAmountInput.addEventListener('input', (e) => {
                orderState.donationAmount = parseFloat((e.target as HTMLInputElement).value) || 0;
                updateOrderSummary();
            });
        }

        // Form submission
        if (form) {
            form.addEventListener('submit', handleSubmit);
        }
        
        // Backup click handler for pay button
        if (payButton) {
            payButton.addEventListener('click', (e) => {
                console.log('Pay button clicked!', e);
                handleSubmit(e);
            });
        }
    }

    function handleIntentSelection(e: Event) {
        const target = e.target as HTMLElement;
        const intentOption = target.closest('.intent-option') as HTMLElement;
        
        if (!intentOption) return;
        
        const intent = intentOption.dataset.intent as 'tickets' | 'sponsor' | 'donation';
        
        // Update visual selection
        document.querySelectorAll('.intent-option').forEach(option => {
            option.classList.remove('border-brand', 'bg-brand/10');
            option.classList.add('border-gray-200');
        });
        
        intentOption.classList.remove('border-gray-200');
        intentOption.classList.add('border-brand', 'bg-brand/10');
        
        userIntent = intent;
        
        if (intent === 'donation') {
            // Redirect to donation page
            window.location.href = '/donate';
        } else {
            // Show the appropriate form section
            showFormSection(intent);
        }
    }

    function showFormSection(intent: 'tickets' | 'sponsor') {
        // Hide all form sections
        document.querySelectorAll('.checkout-step').forEach(step => {
            step.classList.add('hidden');
        });
        
        // Show the selected form section
        const targetSection = document.querySelector(`[data-flow="${intent}"]`);
        if (targetSection) {
            targetSection.classList.remove('hidden');
        }
        
        // Sync contact information between forms
        syncContactInfo();
    }
    
    function syncContactInfo() {
        const emailInput = document.getElementById('email') as HTMLInputElement;
        const phoneInput = document.getElementById('phone') as HTMLInputElement;
        const sponsorEmailInput = document.getElementById('sponsor-email') as HTMLInputElement;
        const sponsorPhoneInput = document.getElementById('sponsor-phone') as HTMLInputElement;
        
        // If we have email/phone in state, populate both forms
        if (orderState.email && emailInput && sponsorEmailInput) {
            emailInput.value = orderState.email;
            sponsorEmailInput.value = orderState.email;
        }
        
        if (orderState.phone && phoneInput && sponsorPhoneInput) {
            phoneInput.value = orderState.phone;
            sponsorPhoneInput.value = orderState.phone;
        }
    }

    function switchToSponsorFlow() {
        userIntent = 'sponsor';
        showFormSection('sponsor');
    }

    function handleSponsorSelection(e: Event) {
        const target = e.target as HTMLElement;
        const sponsorOption = target.closest('.sponsor-option') as HTMLElement;
        const radioInput = sponsorOption.querySelector('input[type="radio"]') as HTMLInputElement;
        
        // Update visual selection
        document.querySelectorAll('.sponsor-option').forEach(option => {
            option.classList.remove('border-brand', 'bg-brand/10');
            option.classList.add('border-gray-200');
        });
        
        sponsorOption.classList.remove('border-gray-200');
        sponsorOption.classList.add('border-brand', 'bg-brand/10');
        
        // Check the radio button
        radioInput.checked = true;
        orderState.sponsorPackage = radioInput.value;
        
        updateOrderSummary();
    }

    function handleQuantityChange(e: Event) {
        const target = e.target as HTMLElement;
        const action = target.dataset.action;
        const type = target.dataset.type;
        const display = document.querySelector(`.quantity-display[data-type="${type}"]`) as HTMLElement;
        
        console.log('Quantity change:', { action, type, display, target });
        
        if (!display) {
            console.error('Display element not found for type:', type);
            return;
        }
        
        let currentValue = parseInt(display.textContent || '0') || 0;
        
        if (action === 'increase') {
            // Check drawing entry limits
            if (type === 'raffle-total') {
                if (orderState.raffleTotal >= 50) {
                    showError('Maximum 50 drawing entries per person');
                    return;
                }
            }
            currentValue++;
        } else if (action === 'decrease' && currentValue > 0) {
            currentValue--;
        }
        
        // Only update if this is actually a quantity display element
        if (display.classList.contains('quantity-display')) {
            display.textContent = currentValue.toString();
        } else {
            console.error('Target element is not a quantity display:', display);
        }
        
        // Update state
        switch (type) {
            case 'regular':
                orderState.regularTickets = currentValue;
                break;
            case 'sponsor-extra':
                orderState.sponsorExtraTickets = currentValue;
                break;
            case 'raffle-total':
                orderState.raffleTotal = currentValue;
                calculateOptimalRafflePricing();
                break;
        }
        
        updateOrderSummary();
    }

    function calculateOptimalRafflePricing() {
        const total = orderState.raffleTotal;
        
        if (total === 0) {
            orderState.raffleTriplePackages = 0;
            orderState.raffleSingleTickets = 0;
            hideRafflePricingBreakdown();
            return;
        }
        
        // Calculate optimal combination
        const triplePackages = Math.floor(total / 3);
        const remainingTickets = total % 3;
        
        orderState.raffleTriplePackages = triplePackages;
        orderState.raffleSingleTickets = remainingTickets;
        
        // Show pricing breakdown if there are savings
        if (triplePackages > 0) {
            const savings = triplePackages * 10; // $10 saved per triple package
            showRafflePricingBreakdown(total, triplePackages, remainingTickets, savings);
        } else {
            hideRafflePricingBreakdown();
        }
    }

    function showRafflePricingBreakdown(total: number, triplePackages: number, singleTickets: number, savings: number) {
        const breakdownElement = document.getElementById('raffle-pricing-breakdown');
        const breakdownText = document.getElementById('raffle-breakdown-text');
        
        if (!breakdownElement || !breakdownText) return;
        
        let breakdown = `You're buying ${total} drawing entr${total > 1 ? 'ies' : 'y'}: `;
        
        if (triplePackages > 0) {
            breakdown += `${triplePackages} triple package${triplePackages > 1 ? 's' : ''} (${triplePackages * 3} tickets)`;
        }
        
        if (singleTickets > 0) {
            if (triplePackages > 0) breakdown += ' + ';
            breakdown += `${singleTickets} single ticket${singleTickets > 1 ? 's' : ''}`;
        }
        
        breakdown += ` • You save $${savings}!`;
        
        breakdownText.textContent = breakdown;
        breakdownElement.classList.remove('hidden');
    }

    function hideRafflePricingBreakdown() {
        const breakdownElement = document.getElementById('raffle-pricing-breakdown');
        if (breakdownElement) {
            breakdownElement.classList.add('hidden');
        }
    }

    function nextStep() {
        if (!validateCurrentForm()) return;
        
        // Show the payment section
        document.querySelectorAll('.checkout-step').forEach(step => {
            step.classList.add('hidden');
        });
        
        const paymentSection = document.querySelector('[data-step="3"]');
        if (paymentSection) {
            paymentSection.classList.remove('hidden');
            updateOrderSummary();
        }
    }

    function prevStep() {
        // Go back to the options selection
        document.querySelectorAll('.checkout-step').forEach(step => {
            step.classList.add('hidden');
        });
        
        // Reset visual selection
        document.querySelectorAll('.intent-option').forEach(option => {
            option.classList.remove('border-brand', 'bg-brand/10');
            option.classList.add('border-gray-200');
        });
        
        userIntent = null;
    }

    function validateCurrentForm() {
        // Validate email - check both regular and sponsor email fields
        let email = orderState.email.trim();
        
        // If no email in state, try to get it from the visible form
        if (!email) {
            const visibleEmailInput = document.querySelector('input[type="email"]:not([style*="display: none"])') as HTMLInputElement;
            if (visibleEmailInput) {
                email = visibleEmailInput.value.trim();
            }
        }
        
        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            showError('Please enter a valid email address');
            return false;
        }

        // Validate that at least one item is selected
        const hasRegularTickets = orderState.regularTickets > 0;
        const hasSponsorPackage = orderState.sponsorPackage !== null;
        const hasSponsorExtraTickets = orderState.sponsorExtraTickets > 0;
        const hasRaffleTickets = orderState.raffleTotal > 0;

        if (!hasRegularTickets && !hasSponsorPackage && !hasSponsorExtraTickets && !hasRaffleTickets) {
            showError('Please select at least one item to purchase');
            return false;
        }

        return true;
    }



    function updateOrderSummary() {
        const items = [];
        let total = 0;

        // Regular tickets
        if (orderState.regularTickets > 0) {
            const cost = orderState.regularTickets * pricing.regularTicket;
            items.push({
                name: `Regular Admission Ticket${orderState.regularTickets > 1 ? 's' : ''}`,
                cost: cost
            });
            total += cost;
        }

        // Sponsor extra tickets
        if (orderState.sponsorExtraTickets > 0) {
            const cost = orderState.sponsorExtraTickets * pricing.regularTicket;
            items.push({
                name: `Additional Admission Ticket${orderState.sponsorExtraTickets > 1 ? 's' : ''}`,
                cost: cost
            });
            total += cost;
        }

        // Sponsor packages
        if (orderState.sponsorPackage) {
            let cost = 0;
            let name = '';
            switch (orderState.sponsorPackage) {
                case 'gold':
                    cost = pricing.goldSponsor;
                    name = 'Gold Sponsor Package';
                    break;
                case 'silver':
                    cost = pricing.silverSponsor;
                    name = 'Silver Sponsor Package';
                    break;
                case 'bronze':
                    cost = pricing.bronzeSponsor;
                    name = 'Bronze Sponsor Package';
                    break;
            }
            items.push({ name, cost });
            total += cost;
        }

        // Drawing entries (smart pricing)
        if (orderState.raffleTotal > 0) {
            let raffleCost = 0;
            
            if (orderState.raffleTriplePackages > 0) {
                raffleCost += orderState.raffleTriplePackages * pricing.raffleTriple;
            }
            
            if (orderState.raffleSingleTickets > 0) {
                raffleCost += orderState.raffleSingleTickets * pricing.raffleSingle;
            }
            
            // Calculate savings for display
            const regularPrice = orderState.raffleTotal * pricing.raffleSingle;
            const savings = regularPrice - raffleCost;
            
            let raffleName = `${orderState.raffleTotal} Drawing Entr${orderState.raffleTotal > 1 ? 'ies' : 'y'}`;
            if (savings > 0) {
                raffleName += ` (Save $${savings})`;
            }
            
            items.push({
                name: raffleName,
                cost: raffleCost
            });
            total += raffleCost;
        }

        // Donation
        if (orderState.donationOnly && orderState.donationAmount > 0) {
            items.push({
                name: 'Donation',
                cost: orderState.donationAmount
            });
            total += orderState.donationAmount;
        }

        // Processing fees
        if (orderState.payProcessingFees && total > 0) {
            const processingFee = Math.round((total * 0.029 + 0.30) * 100) / 100;
            items.push({
                name: 'Processing Fee Coverage',
                cost: processingFee
            });
            total += processingFee;
        }

        // Update display
        if (items.length > 0) {
            if (orderSummary) {
                orderSummary.innerHTML = items.map(item => 
                    `<div class="flex justify-between py-2">
                        <span>${item.name}</span>
                        <span>$${item.cost.toFixed(2)}</span>
                    </div>`
                ).join('');
            }
            if (totalAmount) {
                totalAmount.textContent = `$${total.toFixed(2)}`;
            }
        } else {
            if (orderSummary) {
                orderSummary.innerHTML = '<div class="text-gray-500 text-center py-4">No items selected</div>';
            }
            if (totalAmount) {
                totalAmount.textContent = '$0.00';
            }
        }
    }

    async function handleSubmit(e: Event) {
        e.preventDefault();
        console.log('Form submitted!', e);
        
        if (!validateCurrentForm()) {
            console.log('Form validation failed');
            return;
        }
        
        console.log('Form validation passed, proceeding with API call');

        setLoading(true);
        hideError();

        try {
            // Build products array
            const products = [];
            let totalAmount = 0;

            // Regular tickets
            if (orderState.regularTickets > 0) {
                products.push({
                    name: `Regular Admission Ticket${orderState.regularTickets > 1 ? 's' : ''}`,
                    description: `Admission, Dinner, and Bake-Off Tasting for ${orderState.regularTickets} ${orderState.regularTickets > 1 ? 'people' : 'person'}`,
                    price: pricing.regularTicket,
                    quantity: orderState.regularTickets,
                    type: 'admission'
                });
                totalAmount += orderState.regularTickets * pricing.regularTicket;
            }

            // Sponsor extra tickets
            if (orderState.sponsorExtraTickets > 0) {
                products.push({
                    name: `Additional Admission Ticket${orderState.sponsorExtraTickets > 1 ? 's' : ''}`,
                    description: `Additional admission tickets beyond sponsor package for ${orderState.sponsorExtraTickets} ${orderState.sponsorExtraTickets > 1 ? 'people' : 'person'}`,
                    price: pricing.regularTicket,
                    quantity: orderState.sponsorExtraTickets,
                    type: 'admission'
                });
                totalAmount += orderState.sponsorExtraTickets * pricing.regularTicket;
            }

            // Sponsor packages
            if (orderState.sponsorPackage) {
                let sponsorName = '';
                let sponsorPrice = 0;
                let sponsorDescription = '';
                
                switch (orderState.sponsorPackage) {
                    case 'gold':
                        sponsorName = 'Gold Sponsor Package';
                        sponsorPrice = pricing.goldSponsor;
                        sponsorDescription = '8 people + Logo/Name on Event Materials';
                        break;
                    case 'silver':
                        sponsorName = 'Silver Sponsor Package';
                        sponsorPrice = pricing.silverSponsor;
                        sponsorDescription = '4 people + Logo/Name on Event Materials';
                        break;
                    case 'bronze':
                        sponsorName = 'Bronze Sponsor Package';
                        sponsorPrice = pricing.bronzeSponsor;
                        sponsorDescription = '2 people + Logo/Name on Event Materials';
                        break;
                }
                
                products.push({
                    name: sponsorName,
                    description: sponsorDescription,
                    price: sponsorPrice,
                    quantity: 1,
                    type: 'sponsor'
                });
                totalAmount += sponsorPrice;
            }

            // Drawing entries (smart pricing - single line item)
            if (orderState.raffleTotal > 0) {
                let raffleCost = 0;
                
                if (orderState.raffleTriplePackages > 0) {
                    raffleCost += orderState.raffleTriplePackages * pricing.raffleTriple;
                }
                
                if (orderState.raffleSingleTickets > 0) {
                    raffleCost += orderState.raffleSingleTickets * pricing.raffleSingle;
                }
                
                // Calculate savings for description
                const regularPrice = orderState.raffleTotal * pricing.raffleSingle;
                const savings = regularPrice - raffleCost;
                
                let description = `${orderState.raffleTotal} drawing entr${orderState.raffleTotal > 1 ? 'ies' : 'y'} for prize drawings`;
                if (savings > 0) {
                    description += ` (Smart pricing applied - Save $${savings}!)`;
                }
                
                products.push({
                    name: `${orderState.raffleTotal} Drawing Entr${orderState.raffleTotal > 1 ? 'ies' : 'y'}`,
                    description: description,
                    price: raffleCost,
                    quantity: 1,
                    type: 'prize_entry'
                });
                totalAmount += raffleCost;
            }

            // Donation
            if (orderState.donationOnly && orderState.donationAmount > 0) {
                products.push({
                    name: 'Donation',
                    description: 'Tax-deductible donation to support Shelter in a Storm',
                    price: orderState.donationAmount,
                    quantity: 1,
                    type: 'donation'
                });
                totalAmount += orderState.donationAmount;
            }

            // Processing fees
            if (orderState.payProcessingFees && totalAmount > 0) {
                const processingFee = Math.round((totalAmount * 0.029 + 0.30) * 100) / 100;
                products.push({
                    name: 'Processing Fee Coverage',
                    description: 'Help cover payment processing fees to maximize funds for our cause',
                    price: processingFee,
                    quantity: 1,
                    type: 'fee'
                });
                totalAmount += processingFee;
            }

            // Prepare request body
            const requestBody = {
                email: orderState.email,
                eventName: eventConfig.name,
                eventDate: eventConfig.date,
                products: products,
                bakeOffEntry: orderState.bakeOffEntry,
                coverFees: orderState.payProcessingFees
            };

            let response;
            if (orderState.donationOnly && !orderState.regularTickets && !orderState.sponsorPackage && !orderState.raffleTotal) {
                // Donation only - use donation API
                response = await fetch('https://api.shelterinastorm.org/api/v2/donation.js', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: orderState.donationAmount,
                        email: orderState.email,
                        donationType: 'one-time'
                    })
                });
            } else {
                // Event tickets - use comprehensive API
                response = await fetch(STRIPE_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
            }

            // Handle response properly
            let data;
            const contentType = response.headers.get('content-type');
            
            if (contentType && contentType.includes('application/json')) {
                data = await response.json();
            } else {
                const text = await response.text();
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error(`Server returned invalid response: ${text.substring(0, 100)}`);
                }
            }

            if (data.success && data.url) {
                // Redirect to Stripe checkout
                window.location.href = data.url;
            } else {
                throw new Error(data.message || 'Failed to create checkout session');
            }
        } catch (error) {
            console.error('Error:', error);
            showError(error instanceof Error ? error.message : 'An error occurred. Please try again.');
        } finally {
            setLoading(false);
        }
    }

    function setLoading(loading: boolean) {
        if (!payButton) return;
        
        if (loading) {
            payButton.disabled = true;
            payButton.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Processing...
            `;
        } else {
            payButton.disabled = false;
            payButton.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                </svg>
                Proceed to Payment
            `;
        }
    }

    function showError(message: string) {
        if (errorText) {
            errorText.textContent = message;
        }
        if (errorMessage) {
            errorMessage.classList.remove('hidden');
        }
    }

    function hideError() {
        if (errorMessage) {
            errorMessage.classList.add('hidden');
        }
    }
</script>

<style>
    /* Professional checkout styling */
    .intent-option {
        transition: all 0.2s ease;
    }
    
    .intent-option:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .sponsor-option {
        transition: all 0.2s ease;
    }
    
    .sponsor-option:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .quantity-btn {
        transition: all 0.2s ease;
        flex-shrink: 0;
    }
    
    .quantity-btn:hover {
        transform: scale(1.1);
    }
    
    .quantity-btn:active {
        transform: scale(0.95);
    }
    
    .quantity-display {
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Loading animation */
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .animate-spin {
        animation: spin 1s linear infinite;
    }
    
    /* Smooth transitions */
    .checkout-step {
        transition: all 0.3s ease;
    }
    
    /* Focus states */
    input:focus, button:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Professional shadows */
    .shadow-xl {
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .shadow-lg {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
</style>

