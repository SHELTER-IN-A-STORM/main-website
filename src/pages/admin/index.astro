---
import Layout from '../../layouts/Layout.astro';

// API configuration
const API_URL = "https://api.shopblox.gg/internal/password";
const API_KEY = "6e9d9038-468e-4dd6-a239-f99bfda30495";

let isAuthenticated = false;
---

<Layout title="Admin Dashboard">
    <div class="min-h-screen py-12 bg-gray-50">
        <div class="container mx-auto px-4">
            <!-- Simple Alert -->
            <div 
                id="admin-alert" 
                class="fixed top-4 right-4 max-w-sm w-full p-4 bg-white rounded-lg shadow-lg border transform translate-y-[-150%] transition-transform duration-300 z-50"
                role="alert"
            >
                <div class="flex items-center gap-3">
                    <div id="alert-icon" class="flex-shrink-0"></div>
                    <div class="flex-1 min-w-0">
                        <p id="alert-text" class="text-sm font-medium text-gray-900"></p>
                    </div>
                </div>
            </div>

            <div id="login-section" class="max-w-lg mx-auto">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-900">Admin Access</h1>
                    <p class="mt-2 text-gray-600">Enter your admin password to access the dashboard</p>
                </div>
                <form 
                    id="login-form"
                    class="bg-white p-6 rounded-xl shadow-sm border border-gray-100"
                >
                    <div class="space-y-4">
                        <input
                            type="password"
                            id="password"
                            class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-brand focus:ring-2 focus:ring-brand/20 outline-none transition-all"
                            placeholder="Enter password"
                            required
                        />
                        <button
                            type="submit"
                            class="w-full px-4 py-3 bg-brand text-white font-medium rounded-lg hover:bg-brand-dark transition-colors"
                        >
                            Access Admin Panel
                        </button>
                    </div>
                </form>
            </div>

            <div id="admin-panel" class="max-w-4xl mx-auto hidden">
                <div class="text-center mb-12">
                    <div id="welcome-message">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Analytics Card -->
                    <div id="analytics-card" class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="p-3 bg-blue-50 rounded-lg">
                                <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Analytics</h3>
                                <p class="text-sm text-gray-600">View website traffic and user behavior</p>
                            </div>
                        </div>
                        <button
                            onclick="openAnalytics()"
                            class="w-full px-4 py-2 mt-2 text-blue-600 border border-blue-200 rounded-lg hover:bg-blue-50 transition-colors text-sm font-medium"
                        >
                            Open Analytics
                        </button>
                    </div>

                    <!-- Events Card -->
                    <div id="events-card" class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="p-3 bg-green-50 rounded-lg">
                                <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Events</h3>
                                <p class="text-sm text-gray-600">Manage upcoming events</p>
                            </div>
                        </div>
                        <a
                            href="/events"
                            class="block w-full px-4 py-2 mt-2 text-green-600 border border-green-200 rounded-lg hover:bg-green-50 transition-colors text-center text-sm font-medium"
                        >
                            View Events
                        </a>
                    </div>

                    <!-- Donation Management -->
                    <div id="donations-card" class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="p-3 bg-purple-50 rounded-lg">
                                <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Donations</h3>
                                <p class="text-sm text-gray-600">View and manage donation records</p>
                            </div>
                        </div>
                        <a
                            href="https://www.paypal.com/signin"
                            target="_blank"
                            class="block w-full px-4 py-2 mt-2 text-purple-600 border border-purple-200 rounded-lg hover:bg-purple-50 transition-colors text-center text-sm font-medium"
                        >
                            Access PayPal Dashboard
                        </a>
                    </div>

                    <!-- Food Pantry Management -->
                    <div id="pantry-card" class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="p-3 bg-yellow-50 rounded-lg">
                                <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Food Pantry</h3>
                                <p class="text-sm text-gray-600">Track inventory and requests</p>
                            </div>
                        </div>
                        <a
                            href="https://docs.google.com/spreadsheets/create"
                            target="_blank"
                            class="block w-full px-4 py-2 mt-2 text-yellow-600 border border-yellow-200 rounded-lg hover:bg-yellow-50 transition-colors text-center text-sm font-medium"
                        >
                            Open Inventory Sheet
                        </a>
                    </div>

                    <!-- Emergency Assistance -->
                    <div id="emergency-card" class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="p-3 bg-red-50 rounded-lg">
                                <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Emergency Assistance</h3>
                                <p class="text-sm text-gray-600">Manage assistance requests</p>
                            </div>
                        </div>
                        <a
                            href="https://forms.gle/create"
                            target="_blank"
                            class="block w-full px-4 py-2 mt-2 text-red-600 border border-red-200 rounded-lg hover:bg-red-50 transition-colors text-center text-sm font-medium"
                        >
                            View Request Forms
                        </a>
                    </div>

                    <!-- Social Media -->
                    <div id="social-card" class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="p-3 bg-pink-50 rounded-lg">
                                <svg class="w-6 h-6 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Social Media</h3>
                                <p class="text-sm text-gray-600">Manage social media accounts</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <a
                                href="https://www.facebook.com/"
                                target="_blank"
                                class="px-4 py-2 text-blue-600 border border-blue-200 rounded-lg hover:bg-blue-50 transition-colors text-center text-sm font-medium"
                            >
                                Facebook
                            </a>
                            <a
                                href="https://www.instagram.com/"
                                target="_blank"
                                class="px-4 py-2 text-pink-600 border border-pink-200 rounded-lg hover:bg-pink-50 transition-colors text-center text-sm font-medium"
                            >
                                Instagram
                            </a>
                        </div>
                    </div>

                    <!-- Dev Tools -->
                    <div id="dev-tools-card" class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="p-3 bg-indigo-50 rounded-lg">
                                <svg class="w-6 h-6 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Developer Tools</h3>
                                <p class="text-sm text-gray-600">Access development resources</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <a
                                href="https://github.com/InactiveBen/api.shopblox.gg"
                                target="_blank"
                                class="px-4 py-2 text-indigo-600 border border-indigo-200 rounded-lg hover:bg-indigo-50 transition-colors text-center text-sm font-medium"
                            >
                                GitHub Repo
                            </a>
                            <a
                                href="/internal/password"
                                target="_blank"
                                class="px-4 py-2 text-indigo-600 border border-indigo-200 rounded-lg hover:bg-indigo-50 transition-colors text-center text-sm font-medium"
                            >
                                Password Reset
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</Layout>

<script define:vars={{ API_KEY, API_URL }}>
    // Map domains to their respective card IDs
    const domainCards = {
        'Website': ['events-card'],
        'Analytics': ['analytics-card'],
        'Social Media': ['social-card'],
        'Donations': ['donations-card'],
        'Food Pantry': ['pantry-card'],
        'Emergency': ['emergency-card'],
        'Developer': ['dev-tools-card']
    };

    // Function to show/hide cards based on domains
    const updateVisibleCards = (domains) => {
        // Hide all cards first
        Object.values(domainCards).flat().forEach(cardId => {
            const card = document.getElementById(cardId);
            if (card) card.classList.add('hidden');
        });

        // Show only authorized cards
        domains.forEach(domain => {
            const cardIds = domainCards[domain] || [];
            cardIds.forEach(cardId => {
                const card = document.getElementById(cardId);
                if (card) card.classList.remove('hidden');
            });
        });
    };

    // Alert functionality
    const showAlert = (message, type = 'error') => {
        const alert = document.getElementById('admin-alert');
        const alertText = document.getElementById('alert-text');
        const alertIcon = document.getElementById('alert-icon');
        
        alertText.textContent = message;
        
        alertIcon.innerHTML = type === 'error' 
            ? `<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>`
            : `<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>`;
        
        alert.className = `fixed top-4 right-4 max-w-sm w-full p-4 bg-white rounded-lg shadow-lg border transform transition-transform duration-300 z-50 ${
            type === 'error' ? 'border-red-100' : 'border-green-100'
        }`;
        
        alert.style.transform = 'translateY(0)';
        
        setTimeout(() => {
            alert.style.transform = 'translateY(-150%)';
        }, 3000);
    };

    // Handle login
    document.getElementById('login-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const password = document.getElementById('password').value;
        
        console.log('Attempting login with:', { password });
        
        try {
            // Add timeout to fetch
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Authorization': API_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    password: password
                }),
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                console.error('API Error:', errorData);
                throw new Error(errorData.message || 'API request failed');
            }
            
            const data = await response.json();
            console.log('API Response:', data);
            
            if (data.success && data.valid) {
                // Personalized welcome messages based on role
                const welcomeMessages = {
                    'Domain Administrator': `Welcome back, ${data.username}! You have full access to manage all domains.`,
                    'Domain Manager': `Welcome, ${data.username}! You can manage website content and view analytics.`,
                    'Social Media Manager': `Hi ${data.username}! Ready to manage our social media presence?`,
                    'Analytics Manager': `Welcome ${data.username}! View and analyze our latest metrics.`
                };
                
                showAlert(welcomeMessages[data.role] || `Welcome back, ${data.username}!`, 'success');
                
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');

                // Enhanced welcome message with role-specific styling and quick actions
                const welcomeDiv = document.getElementById('welcome-message');
                const roleColors = {
                    'Domain Administrator': 'text-brand',
                    'Domain Manager': 'text-blue-600',
                    'Social Media Manager': 'text-pink-600',
                    'Analytics Manager': 'text-green-600'
                };
                
                welcomeDiv.innerHTML = `
                    <h1 class="text-3xl font-bold text-gray-900">
                        Welcome, <span class="${roleColors[data.role] || 'text-brand'}">${data.username}</span>
                    </h1>
                    <p class="mt-2 text-gray-600">
                        <span class="font-medium ${roleColors[data.role] || 'text-brand'}">${data.role}</span>
                        <span class="mx-2">â€¢</span>
                        ${data.domains.map(domain => `
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                ${domain}
                            </span>
                        `).join(' ')}
                    </p>
                    ${getRoleSpecificActions(data.role, data.domains)}
                `;

                // Update visible cards based on domains
                updateVisibleCards(data.domains);
            } else {
                showAlert(data.message || 'Incorrect password. Please try again.');
                document.getElementById('password').value = '';
            }
        } catch (error) {
            console.error('Detailed error:', error);
            let errorMessage = 'Network error. Please try again later.';
            if (error.name === 'AbortError') {
                errorMessage = 'Request timed out. Please try again.';
            }
            showAlert(errorMessage);
            document.getElementById('password').value = '';
        }
    });

    // Function to get role-specific quick actions
    function getRoleSpecificActions(role, domains) {
        const actions = {
            'Domain Administrator': `
                <div class="mt-6 flex flex-wrap gap-4 justify-center">
                    <a href="https://analytics.google.com" target="_blank" 
                       class="inline-flex items-center px-4 py-2 border border-brand text-brand hover:bg-brand hover:text-white rounded-lg transition-colors">
                        View Analytics Dashboard
                    </a>
                    <a href="https://github.com/InactiveBen/api.shopblox.gg" target="_blank"
                       class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
                        Access Developer Tools
                    </a>
                </div>
            `,
            'Domain Manager': `
                <div class="mt-6 flex flex-wrap gap-4 justify-center">
                    <a href="/events" 
                       class="inline-flex items-center px-4 py-2 border border-blue-600 text-blue-600 hover:bg-blue-600 hover:text-white rounded-lg transition-colors">
                        Manage Events
                    </a>
                </div>
            `,
            'Social Media Manager': `
                <div class="mt-6 flex flex-wrap gap-4 justify-center">
                    <a href="https://business.facebook.com" target="_blank"
                       class="inline-flex items-center px-4 py-2 border border-pink-600 text-pink-600 hover:bg-pink-600 hover:text-white rounded-lg transition-colors">
                        Open Social Media Hub
                    </a>
                </div>
            `,
            'Analytics Manager': `
                <div class="mt-6 flex flex-wrap gap-4 justify-center">
                    <a href="https://analytics.google.com" target="_blank"
                       class="inline-flex items-center px-4 py-2 border border-green-600 text-green-600 hover:bg-green-600 hover:text-white rounded-lg transition-colors">
                        View Analytics
                    </a>
                </div>
            `
        };
        
        return actions[role] || '';
    }

    // Open analytics in new tab
    window.openAnalytics = () => {
        window.open('https://analytics.google.com/analytics/web/', '_blank');
    };
</script>

<style>
    .animate-fade-in {
        animation: fadeIn 0.8s ease-out;
    }

    .animate-slide-up {
        animation: slideUp 0.8s ease-out;
    }

    .animate-slide-up-delay-1 {
        animation: slideUp 0.8s ease-out 0.2s both;
    }

    .animate-slide-up-delay-2 {
        animation: slideUp 0.8s ease-out 0.4s both;
    }

    .animate-slide-up-delay-3 {
        animation: slideUp 0.8s ease-out 0.6s both;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style> 