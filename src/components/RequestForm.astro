---
import { siteConfig } from '../config/site';

interface Props {
  id?: string;
  showHeader?: boolean;
}

const { id = 'request', showHeader = true } = Astro.props;
const formId = `${id}-form`;
---

<div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
  {showHeader && (
    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
      <h3 class="font-semibold text-gray-900">Request Assistance</h3>
      <p class="text-sm text-gray-500 mt-1">All fields marked with * are required</p>
    </div>
  )}
  
  <form id={formId} class="p-6 space-y-6">
    <!-- Hidden UTM and Referral Fields -->
    <input type="hidden" name="utm_source" id="utm_source" />
    <input type="hidden" name="utm_medium" id="utm_medium" />
    <input type="hidden" name="utm_campaign" id="utm_campaign" />
    <input type="hidden" name="utm_term" id="utm_term" />
    <input type="hidden" name="utm_content" id="utm_content" />
    <input type="hidden" name="referral" id="referral" />

    <!-- Type of Assistance -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">What do you need help with? *</label>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <label class="relative">
          <input type="radio" name="assistance" value="foodbox" class="peer sr-only" required />
          <div class="px-4 py-3 border border-gray-300 bg-white cursor-pointer peer-checked:border-brand peer-checked:ring-1 peer-checked:ring-brand transition-all text-center rounded">
            <svg class="w-5 h-5 mx-auto mb-1 text-gray-400 peer-checked:text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
            <span class="font-medium text-gray-900 text-sm">Food Box</span>
          </div>
        </label>
        <label class="relative">
          <input type="radio" name="assistance" value="homelessness" class="peer sr-only" />
          <div class="px-4 py-3 border border-gray-300 bg-white cursor-pointer peer-checked:border-brand peer-checked:ring-1 peer-checked:ring-brand transition-all text-center rounded">
            <svg class="w-5 h-5 mx-auto mb-1 text-gray-400 peer-checked:text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
            <span class="font-medium text-gray-900 text-sm">Housing Help</span>
          </div>
        </label>
        <label class="relative">
          <input type="radio" name="assistance" value="other" class="peer sr-only" />
          <div class="px-4 py-3 border border-gray-300 bg-white cursor-pointer peer-checked:border-brand peer-checked:ring-1 peer-checked:ring-brand transition-all text-center rounded">
            <svg class="w-5 h-5 mx-auto mb-1 text-gray-400 peer-checked:text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <span class="font-medium text-gray-900 text-sm">Other</span>
          </div>
        </label>
      </div>
    </div>

    <!-- Other Support Description (only shown if 'other' is selected) -->
    <div id="otherSupportDetails" class="hidden">
      <label class="block text-sm font-medium text-gray-700 mb-2">Please describe what you need *</label>
      <textarea 
        id="otherSupportDescription" 
        name="otherSupportDescription" 
        rows="3"
        placeholder="Tell us how we can help you..."
        class="w-full px-3 py-2.5 border border-gray-300 rounded bg-white focus:border-brand focus:ring-1 focus:ring-brand focus:outline-none resize-none"
      ></textarea>
    </div>

    <!-- Dietary Restrictions (only shown if 'foodbox' is selected) -->
    <div id="foodOptions" class="hidden">
      <label class="block text-sm font-medium text-gray-700 mb-2">Dietary Restrictions (optional)</label>
      <div class="flex flex-wrap gap-2">
        <label class="dietary-option">
          <input type="checkbox" name="dietary[]" value="vegetarian" class="sr-only peer" />
          <span class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-full text-sm cursor-pointer peer-checked:border-brand peer-checked:bg-brand/5 peer-checked:text-brand transition-all">
            Vegetarian
          </span>
        </label>
        <label class="dietary-option">
          <input type="checkbox" name="dietary[]" value="gluten-free" class="sr-only peer" />
          <span class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-full text-sm cursor-pointer peer-checked:border-brand peer-checked:bg-brand/5 peer-checked:text-brand transition-all">
            Gluten-Free
          </span>
        </label>
        <label class="dietary-option">
          <input type="checkbox" name="dietary[]" value="dairy-free" class="sr-only peer" />
          <span class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-full text-sm cursor-pointer peer-checked:border-brand peer-checked:bg-brand/5 peer-checked:text-brand transition-all">
            Dairy-Free
          </span>
        </label>
      </div>
    </div>

    <!-- Divider -->
    <div class="border-t border-gray-200 pt-6">
      <p class="text-sm font-medium text-gray-700 mb-4">Your Information</p>
    </div>

    <!-- Name Fields -->
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
        <input 
          type="text" 
          name="firstName" 
          required
          placeholder="John"
          class="w-full px-3 py-2.5 border border-gray-300 rounded bg-white focus:border-brand focus:ring-1 focus:ring-brand focus:outline-none"
        />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
        <input 
          type="text" 
          name="lastName" 
          required
          placeholder="Doe"
          class="w-full px-3 py-2.5 border border-gray-300 rounded bg-white focus:border-brand focus:ring-1 focus:ring-brand focus:outline-none"
        />
      </div>
    </div>

    <!-- Contact Info -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
      <input 
        type="tel" 
        id="phone"
        name="phone" 
        required
        placeholder="(555) 123-4567"
        class="w-full px-3 py-2.5 border border-gray-300 rounded bg-white focus:border-brand focus:ring-1 focus:ring-brand focus:outline-none"
      />
      <p class="text-xs text-gray-500 mt-1">We'll call or text to follow up on your request.</p>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
      <input 
        type="email" 
        name="email"
        placeholder="you@example.com"
        class="w-full px-3 py-2.5 border border-gray-300 rounded bg-white focus:border-brand focus:ring-1 focus:ring-brand focus:outline-none"
      />
    </div>

    <!-- Divider -->
    <div class="border-t border-gray-200 pt-6">
      <p class="text-sm font-medium text-gray-700 mb-4">Household Information</p>
    </div>

    <!-- Household Size -->
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Household Size *</label>
        <select 
          name="householdSize" 
          required
          class="w-full px-3 py-2.5 border border-gray-300 rounded bg-white focus:border-brand focus:ring-1 focus:ring-brand focus:outline-none"
        >
          <option value="">Select...</option>
          <option value="1">1 person</option>
          <option value="2">2 people</option>
          <option value="3">3 people</option>
          <option value="4">4 people</option>
          <option value="5">5 people</option>
          <option value="6">6 people</option>
          <option value="7">7 people</option>
          <option value="8+">8+ people</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Children Under 18 *</label>
        <select 
          name="minorsCount" 
          required
          class="w-full px-3 py-2.5 border border-gray-300 rounded bg-white focus:border-brand focus:ring-1 focus:ring-brand focus:outline-none"
        >
          <option value="">Select...</option>
          <option value="0">None</option>
          <option value="1">1 child</option>
          <option value="2">2 children</option>
          <option value="3">3 children</option>
          <option value="4">4 children</option>
          <option value="5+">5+ children</option>
        </select>
      </div>
    </div>

    <!-- Address -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Street Address *</label>
      <input 
        type="text" 
        name="street" 
        required
        placeholder="123 Main Street"
        class="w-full px-3 py-2.5 border border-gray-300 rounded bg-white focus:border-brand focus:ring-1 focus:ring-brand focus:outline-none"
      />
    </div>

    <div class="grid grid-cols-5 gap-3">
      <div class="col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-2">City *</label>
        <input 
          type="text" 
          name="city" 
          required
          placeholder="Lake Ozark"
          class="w-full px-3 py-2.5 border border-gray-300 rounded bg-white focus:border-brand focus:ring-1 focus:ring-brand focus:outline-none"
        />
      </div>
      <div class="col-span-1">
        <label class="block text-sm font-medium text-gray-700 mb-2">State *</label>
        <input 
          type="text" 
          name="state" 
          required
          value="MO"
          maxlength="2"
          class="w-full px-3 py-2.5 border border-gray-300 rounded bg-white focus:border-brand focus:ring-1 focus:ring-brand focus:outline-none"
        />
      </div>
      <div class="col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-2">ZIP Code *</label>
        <input 
          type="text" 
          name="zipcode" 
          required
          placeholder="65049"
          maxlength="10"
          class="w-full px-3 py-2.5 border border-gray-300 rounded bg-white focus:border-brand focus:ring-1 focus:ring-brand focus:outline-none"
        />
      </div>
    </div>

    <!-- Monthly Income -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Approximate Monthly Household Income *</label>
      <select 
        name="householdIncome" 
        required
        class="w-full px-3 py-2.5 border border-gray-300 rounded bg-white focus:border-brand focus:ring-1 focus:ring-brand focus:outline-none"
      >
        <option value="">Select range...</option>
        <option value="0-500">$0 - $500</option>
        <option value="500-1000">$500 - $1,000</option>
        <option value="1000-1500">$1,000 - $1,500</option>
        <option value="1500-2000">$1,500 - $2,000</option>
        <option value="2000-2500">$2,000 - $2,500</option>
        <option value="2500-3000">$2,500 - $3,000</option>
        <option value="3000+">$3,000+</option>
      </select>
    </div>

    <!-- Additional Info -->
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Anything else we should know?</label>
      <textarea 
        name="additionalInfo" 
        rows="3"
        placeholder="Share any additional details that might help us assist you better..."
        class="w-full px-3 py-2.5 border border-gray-300 rounded bg-white focus:border-brand focus:ring-1 focus:ring-brand focus:outline-none resize-none"
      ></textarea>
    </div>

    <!-- Terms Agreement -->
    <div class="flex items-start gap-3 py-4 border-t border-b border-gray-200">
      <label class="custom-checkbox-wrapper">
        <input 
          type="checkbox" 
          name="termsAgreement"
          id="termsAgreement"
          required
          class="terms-checkbox sr-only"
        />
        <span class="custom-checkbox" aria-hidden="true">
          <svg class="checkmark" viewBox="0 0 12 10" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M1 5L4.5 8.5L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
      </label>
      <label for="termsAgreement" class="cursor-pointer flex-1">
        <span class="text-sm text-gray-600">
          I agree to the <a href="/legal/terms" class="text-brand hover:underline" target="_blank">Terms of Service</a> 
          and <a href="/legal/privacy" class="text-brand hover:underline" target="_blank">Privacy Policy</a>. 
          I understand my information will be used to process my assistance request. *
        </span>
      </label>
    </div>

    <!-- Submit Button -->
    <button 
      type="submit"
      class="submit-btn w-full bg-brand hover:bg-brand-dark text-white font-medium py-3 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
    >
      <span class="btn-text">Submit Request</span>
      <span class="btn-loading hidden">Submitting...</span>
    </button>

    <!-- Response Time Note -->
    <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-lg border border-gray-100">
      <div class="p-2 bg-brand/10 rounded-lg flex-shrink-0">
        <svg class="w-5 h-5 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      <div>
        <span class="text-sm font-medium text-gray-900">Response Time</span>
        <span class="block text-xs text-gray-500">We'll respond within 2-3 business days. For immediate food needs, visit our 24/7 pantry.</span>
      </div>
    </div>

    <!-- Security Note -->
    <div class="flex items-center justify-center gap-1.5 text-xs text-gray-400 pt-2">
      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
      </svg>
      <span>Your information is kept confidential</span>
    </div>
  </form>
</div>

<style>
  /* Custom Checkbox Styles */
  .custom-checkbox-wrapper {
    display: inline-flex;
    align-items: flex-start;
    cursor: pointer;
    flex-shrink: 0;
  }

  .custom-checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid #d1d5db;
    border-radius: 4px;
    background-color: #fff;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease-in-out;
    margin-top: 1px;
  }

  .custom-checkbox .checkmark {
    width: 12px;
    height: 10px;
    color: #fff;
    opacity: 0;
    transform: scale(0.5);
    transition: all 0.15s ease-in-out;
  }

  /* Hover state */
  .custom-checkbox-wrapper:hover .custom-checkbox {
    border-color: var(--color-brand, #666ed8);
    background-color: rgba(102, 110, 216, 0.05);
  }

  /* Focus state */
  .terms-checkbox:focus + .custom-checkbox {
    border-color: var(--color-brand, #666ed8);
    box-shadow: 0 0 0 3px rgba(102, 110, 216, 0.15);
  }

  /* Checked state */
  .terms-checkbox:checked + .custom-checkbox {
    background-color: var(--color-brand, #666ed8);
    border-color: var(--color-brand, #666ed8);
  }

  .terms-checkbox:checked + .custom-checkbox .checkmark {
    opacity: 1;
    transform: scale(1);
  }

  /* Checked + hover state */
  .custom-checkbox-wrapper:hover .terms-checkbox:checked + .custom-checkbox {
    background-color: var(--color-brand-dark, #5059c8);
    border-color: var(--color-brand-dark, #5059c8);
  }

  /* Radio button checked state for icons */
  input[type="radio"]:checked + div svg {
    color: var(--color-brand, #666ed8);
  }
</style>

<script is:inline>
  (function() {
    function initRequestForm() {
      // Find the form - look for any form with ID ending in '-form' within our component
      const form = document.querySelector('form[id$="-form"]') || document.getElementById('request-form');
      if (!form) {
        console.warn('Request form not found');
        return;
      }

      // Function to get cookie value by name
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }

      // Populate hidden fields with UTM and referral data
      const utmFields = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'referral'];
      utmFields.forEach(field => {
        const value = getCookie(field);
        if (value) {
          const input = form.querySelector(`[name="${field}"]`);
          if (input) input.value = value;
        }
      });

      // Check for existing submission
      function checkSubmissionStatus() {
        if (document.cookie.split(';').some((item) => item.trim().startsWith('formSubmitted='))) {
          const message = document.createElement('div');
          message.className = 'p-4 bg-yellow-50 text-yellow-800 rounded-lg mb-6 border border-yellow-200';
          message.innerHTML = `
            <p class="font-medium">You have recently submitted a request.</p>
            <p class="text-sm mt-1">Please wait 2-3 days before submitting another request. If you need immediate assistance, 
            our food pantry is available 24/7.</p>
          `;
          form.insertBefore(message, form.firstChild);
          
          // Disable form
          form.querySelectorAll('input, select, textarea, button').forEach(el => {
            el.disabled = true;
          });
        }
      }

      checkSubmissionStatus();

      // Handle assistance type change
      const assistanceRadios = form.querySelectorAll('input[name="assistance"]');
      const foodOptions = document.getElementById('foodOptions');
      const otherSupportDetails = document.getElementById('otherSupportDetails');
      const otherDescription = document.getElementById('otherSupportDescription');

      assistanceRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
          const value = e.target.value;
          
          if (value === 'foodbox') {
            foodOptions?.classList.remove('hidden');
            otherSupportDetails?.classList.add('hidden');
            if (otherDescription) otherDescription.removeAttribute('required');
          } else if (value === 'other') {
            otherSupportDetails?.classList.remove('hidden');
            foodOptions?.classList.add('hidden');
            if (otherDescription) otherDescription.setAttribute('required', '');
          } else {
            foodOptions?.classList.add('hidden');
            otherSupportDetails?.classList.add('hidden');
            if (otherDescription) otherDescription.removeAttribute('required');
          }
        });
      });

      // Format phone number as user types
      const phoneInput = form.querySelector('input[name="phone"]');
      if (phoneInput) {
        phoneInput.addEventListener('input', (e) => {
          let value = e.target.value.replace(/\D/g, '');
          value = value.substring(0, 10);
          
          // Format as (XXX) XXX-XXXX
          if (value.length > 6) {
            value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6)}`;
          } else if (value.length > 3) {
            value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
          } else if (value.length > 0) {
            value = `(${value}`;
          }
          
          e.target.value = value;
        });
      }

      // Form submission
      const submitBtn = form.querySelector('.submit-btn');
      const btnText = form.querySelector('.btn-text');
      const btnLoading = form.querySelector('.btn-loading');

      function resetButton() {
        if (submitBtn) submitBtn.disabled = false;
        if (btnText) btnText.classList.remove('hidden');
        if (btnLoading) btnLoading.classList.add('hidden');
      }

      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Check if submission cookie exists
        if (document.cookie.split(';').some((item) => item.trim().startsWith('formSubmitted='))) {
          alert('You have already submitted a request. Please wait 2-3 days before submitting another request.');
          return;
        }

        // Validation
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;
        let firstInvalidField = null;

        requiredFields.forEach(field => {
          if (field.type === 'checkbox' && !field.checked) {
            isValid = false;
            field.closest('.custom-checkbox-wrapper')?.querySelector('.custom-checkbox')?.classList.add('border-red-500');
            if (!firstInvalidField) firstInvalidField = field;
          } else if (field.type === 'radio') {
            // Check if at least one radio in the group is selected
            const name = field.name;
            const checked = form.querySelector(`input[name="${name}"]:checked`);
            if (!checked) {
              isValid = false;
              if (!firstInvalidField) firstInvalidField = field;
            }
          } else if (!field.value) {
            isValid = false;
            field.classList.add('border-red-500');
            if (!firstInvalidField) firstInvalidField = field;
          } else {
            field.classList.remove('border-red-500');
          }
        });

        if (!isValid) {
          alert('Please fill in all required fields.');
          if (firstInvalidField) {
            firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          return;
        }

        // Show loading
        if (submitBtn) submitBtn.disabled = true;
        if (btnText) btnText.classList.add('hidden');
        if (btnLoading) btnLoading.classList.remove('hidden');

        // Submit form
        const formData = new FormData(form);
        
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
          
          const response = await fetch('https://formspree.io/f/mjkykawl', {
            method: 'POST',
            body: formData,
            headers: {
              'Accept': 'application/json'
            },
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);

          const result = await response.json().catch(() => ({}));
          
          if (response.ok) {
            // Set cookie to expire in 2 days
            const d = new Date();
            d.setTime(d.getTime() + (2 * 24 * 60 * 60 * 1000));
            document.cookie = `formSubmitted=true;expires=${d.toUTCString()};path=/`;
            
            // Redirect to thank you page
            window.location.href = '/thank-you';
          } else {
            console.error('Form error:', result);
            throw new Error(result.error || 'Form submission failed');
          }
        } catch (error) {
          console.error('Submission error:', error);
          
          if (error.name === 'AbortError') {
            alert('Request timed out. Please check your internet connection and try again.');
          } else {
            alert('There was a problem submitting your form. Please try again.');
          }
          
          resetButton();
        }
      });

      // Remove error styling on input
      form.querySelectorAll('input, select, textarea').forEach(field => {
        field.addEventListener('input', () => {
          field.classList.remove('border-red-500');
        });
      });
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initRequestForm);
    } else {
      initRequestForm();
    }
  })();
</script>
