---
// Import any necessary dependencies
import { siteConfig } from '../config/site';

const formSteps = [
    'Personal Info',
    'Contact Details',
    'Household Info',
    'Assistance Type',
    'Additional Info'
];
---

<div class="grid md:grid-cols-2 gap-12 items-start">
    <!-- Form -->
    <form 
        id="multi-step-form" 
        class="space-y-6"
        onsubmit="return false;"
    >
        <!-- Progress Steps -->
        <div class="flex justify-between mb-8">
            {formSteps.map((step, index) => (
                <div class="flex flex-col items-center">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center border-2 transition-colors duration-300 
                        border-gray-300 text-gray-400" data-step-indicator={index + 1}>
                        {index + 1}
                    </div>
                    <span class="text-sm mt-2 text-gray-600">{step}</span>
                </div>
            ))}
        </div>

        <!-- Step 1: Personal Info -->
        <div class="form-step" data-step="1">
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label for="firstName" class="text-sm font-medium text-gray-900">
                        First Name <span class="text-brand">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="firstName" 
                        name="firstName" 
                        required
                        class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-brand focus:ring-2 focus:ring-brand/20"
                    />
                </div>
                <div class="space-y-2">
                    <label for="lastName" class="text-sm font-medium text-gray-900">
                        Last Name <span class="text-brand">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="lastName" 
                        name="lastName" 
                        required
                        class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-brand focus:ring-2 focus:ring-brand/20"
                    />
                </div>
            </div>
            <div class="mt-8 flex justify-end">
                <button 
                    type="button"
                    class="next-step px-8 py-3 bg-brand text-white rounded-lg font-medium"
                    data-current-step="1"
                >
                    Next Step
                </button>
            </div>
        </div>

        <!-- Step 2: Contact Details -->
        <div class="form-step hidden" data-step="2">
            <div class="space-y-6">
                <div class="space-y-2">
                    <label for="phone" class="text-sm font-medium text-gray-900">
                        Phone Number <span class="text-brand">*</span>
                    </label>
                    <input 
                        type="tel" 
                        id="phone" 
                        name="phone" 
                        required
                        class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-brand focus:ring-2 focus:ring-brand/20"
                    />
                </div>
                <div class="space-y-2">
                    <label for="email" class="text-sm font-medium text-gray-900">Email Address</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-brand focus:ring-2 focus:ring-brand/20"
                    />
                </div>
            </div>
            <div class="mt-8 flex justify-between">
                <button 
                    type="button"
                    class="prev-step px-8 py-3 bg-gray-100 text-gray-900 rounded-lg font-medium"
                    data-current-step="2"
                >
                    Previous
                </button>
                <button 
                    type="button"
                    class="next-step px-8 py-3 bg-brand text-white rounded-lg font-medium"
                    data-current-step="2"
                >
                    Next Step
                </button>
            </div>
        </div>

        <!-- Step 3: Household Info -->
        <div class="form-step hidden" data-step="3">
            <div class="space-y-6">
                <div class="space-y-2">
                    <label for="householdSize" class="text-sm font-medium text-gray-900">
                        Total Household Members <span class="text-brand">*</span>
                    </label>
                    <input 
                        type="number" 
                        id="householdSize" 
                        name="householdSize" 
                        required
                        min="1"
                        class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-brand focus:ring-2 focus:ring-brand/20"
                    />
                </div>

                <div class="space-y-2">
                    <label for="minorsCount" class="text-sm font-medium text-gray-900">
                        Number of Children (Under 18) <span class="text-brand">*</span>
                    </label>
                    <input 
                        type="number" 
                        id="minorsCount" 
                        name="minorsCount" 
                        required
                        min="0"
                        class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-brand focus:ring-2 focus:ring-brand/20"
                    />
                </div>

                <!-- Address Fields -->
                <div class="space-y-4">
                    <h4 class="text-sm font-medium text-gray-900">Current Address <span class="text-brand">*</span></h4>
                    <div class="space-y-2">
                        <label for="street" class="text-sm font-medium text-gray-900">Street Address</label>
                        <input 
                            type="text" 
                            id="street" 
                            name="street" 
                            required
                            class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-brand focus:ring-2 focus:ring-brand/20"
                        />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label for="city" class="text-sm font-medium text-gray-900">City</label>
                            <input 
                                type="text" 
                                id="city" 
                                name="city" 
                                required
                                class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-brand focus:ring-2 focus:ring-brand/20"
                            />
                        </div>
                        <div class="space-y-2">
                            <label for="state" class="text-sm font-medium text-gray-900">State</label>
                            <input 
                                type="text" 
                                id="state" 
                                name="state" 
                                required
                                class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-brand focus:ring-2 focus:ring-brand/20"
                            />
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label for="zipcode" class="text-sm font-medium text-gray-900">ZIP Code</label>
                        <input 
                            type="text" 
                            id="zipcode" 
                            name="zipcode" 
                            required
                            class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-brand focus:ring-2 focus:ring-brand/20"
                        />
                    </div>
                </div>

                <div class="space-y-2">
                    <label for="householdIncome" class="text-sm font-medium text-gray-900">
                        Monthly Household Income <span class="text-brand">*</span>
                    </label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">$</span>
                        <input 
                            type="number" 
                            id="householdIncome" 
                            name="householdIncome" 
                            required
                            min="0"
                            class="w-full pl-8 py-3 rounded-lg border border-gray-200 focus:border-brand focus:ring-2 focus:ring-brand/20"
                        />
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-between">
                <button 
                    type="button"
                    class="prev-step px-8 py-3 bg-gray-100 text-gray-900 rounded-lg font-medium"
                    data-current-step="3"
                >
                    Previous
                </button>
                <button 
                    type="button"
                    class="next-step px-8 py-3 bg-brand text-white rounded-lg font-medium"
                    data-current-step="3"
                >
                    Next Step
                </button>
            </div>
        </div>

        <!-- Step 4: Assistance Type -->
        <div class="form-step hidden" data-step="4">
            <div class="space-y-6">
                <div class="space-y-2">
                    <label for="assistance" class="text-sm font-medium text-gray-900">
                        Type of Assistance <span class="text-brand">*</span>
                    </label>
                    <select 
                        id="assistance" 
                        name="assistance" 
                        required
                        class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-brand focus:ring-2 focus:ring-brand/20"
                    >
                        <option value="">Select assistance type...</option>
                        <option value="foodbox">Food Box</option>
                        <option value="homelessness">Homelessness Prevention</option>
                        <option value="other">Other Support</option>
                    </select>
                </div>
                
                <!-- Other Support Description (only shown if 'other' is selected) -->
                <div id="otherSupportDetails" class="hidden space-y-2">
                    <label for="otherSupportDescription" class="text-sm font-medium text-gray-900">
                        Please describe what type of assistance you need <span class="text-brand">*</span>
                    </label>
                    <textarea 
                        id="otherSupportDescription" 
                        name="otherSupportDescription" 
                        rows="3"
                        class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-brand focus:ring-2 focus:ring-brand/20"
                    ></textarea>
                </div>

                <!-- Food Assistance Options -->
                <div id="foodOptions" class="hidden space-y-4">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-900">Dietary Restrictions</label>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" name="dietary[]" value="vegetarian">
                                <span>Vegetarian</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" name="dietary[]" value="gluten-free">
                                <span>Gluten-Free</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" name="dietary[]" value="dairy-free">
                                <span>Dairy-Free</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-between">
                <button 
                    type="button"
                    class="prev-step px-8 py-3 bg-gray-100 text-gray-900 rounded-lg font-medium"
                    data-current-step="4"
                >
                    Previous
                </button>
                <button 
                    type="button"
                    class="next-step px-8 py-3 bg-brand text-white rounded-lg font-medium"
                    data-current-step="4"
                >
                    Next Step
                </button>
            </div>
        </div>

        <!-- Step 5: Additional Info -->
        <div class="form-step hidden" data-step="5">
            <div class="space-y-6">
                <div class="space-y-2">
                    <label for="additionalInfo" class="text-sm font-medium text-gray-900">
                        Additional Information
                    </label>
                    <textarea 
                        id="additionalInfo" 
                        name="additionalInfo" 
                        rows="4"
                        class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:border-brand focus:ring-2 focus:ring-brand/20"
                    ></textarea>
                </div>

                <!-- Terms and Privacy Policy Agreement -->
                <div class="space-y-2">
                    <label class="flex items-start gap-3">
                        <input 
                            type="checkbox" 
                            id="termsAgreement" 
                            name="termsAgreement" 
                            required
                            class="mt-1 rounded text-brand focus:ring-brand"
                        />
                        <span class="text-sm text-gray-600">
                            I agree to the <a href="/legal/terms" class="text-brand hover:underline" target="_blank">Terms of Service</a> 
                            and <a href="/legal/privacy" class="text-brand hover:underline" target="_blank">Privacy Policy</a>. 
                            I understand that my information will be used to process my assistance request.
                            <span class="text-brand">*</span>
                        </span>
                    </label>
                </div>
            </div>
            <div class="mt-8 flex justify-between">
                <button 
                    type="button"
                    class="prev-step px-8 py-3 bg-gray-100 text-gray-900 rounded-lg font-medium"
                    data-current-step="5"
                >
                    Previous
                </button>
                <button 
                    type="submit"
                    class="px-8 py-3 bg-brand text-white rounded-lg font-medium"
                >
                    Submit Request
                </button>
            </div>
        </div>
    </form>

    <!-- Info Cards -->
    <div class="space-y-6">
        <!-- Food Pantry Card -->
        <div class="bg-white rounded-3xl p-8 shadow-lg border border-gray-100">
            <div class="flex items-start gap-4">
                <div class="p-3 bg-brand/10 rounded-xl">
                    <svg class="w-6 h-6 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h18v18H3zM12 8v8m-4-4h8"/>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">24/7 Food Pantry</h3>
                    <p class="text-gray-600 leading-relaxed">
                        Our food pantry is accessible 24 hours a day, located on the west side of the church. 
                        No appointment needed.
                    </p>
                </div>
            </div>
        </div>

        <!-- Office Hours Card -->
        <div class="bg-white rounded-3xl p-8 shadow-lg border border-gray-100">
            <div class="flex items-start gap-4">
                <div class="p-3 bg-brand/10 rounded-xl">
                    <svg class="w-6 h-6 text-brand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Response Time</h3>
                    <p class="text-gray-600 leading-relaxed">
                        We aim to respond to all requests within 2-3 business days.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Remove spinner arrows from number inputs */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    input[type="number"] {
        -moz-appearance: textfield;
    }
</style>

<script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
        let currentStep = 1;
        const totalSteps = 5;

        // Check for existing submission
        function checkSubmissionStatus() {
            if (document.cookie.split(';').some((item) => item.trim().startsWith('formSubmitted='))) {
                const form = document.getElementById('multi-step-form');
                const message = document.createElement('div');
                message.className = 'p-4 bg-yellow-50 text-yellow-800 rounded-lg mb-6';
                message.innerHTML = `
                    <p class="font-medium">You have recently submitted a request.</p>
                    <p class="text-sm mt-1">Please wait 2-3 days before submitting another request. If you need immediate assistance, 
                    our food pantry is available 24/7.</p>
                `;
                form.insertBefore(message, form.firstChild);
                
                // Disable all form inputs and buttons
                form.querySelectorAll('input, select, textarea, button').forEach(el => {
                    el.disabled = true;
                });
            }
        }

        checkSubmissionStatus();

        function updateStepVisibility() {
            document.querySelectorAll('.form-step').forEach(step => {
                step.classList.add('hidden');
            });
            document.querySelector(`[data-step="${currentStep}"]`)?.classList.remove('hidden');
            
            // Update progress indicators
            document.querySelectorAll('[data-step-indicator]').forEach((indicator, index) => {
                if (index + 1 === currentStep) {
                    indicator.classList.add('bg-brand', 'border-brand', 'text-white');
                } else if (index + 1 < currentStep) {
                    indicator.classList.add('bg-brand', 'border-brand', 'text-white');
                } else {
                    indicator.classList.remove('bg-brand', 'border-brand', 'text-white');
                }
            });
        }

        function validateStep(step) {
            const stepElement = document.querySelector(`[data-step="${step}"]`);
            const requiredFields = stepElement.querySelectorAll('[required]');
            let isValid = true;

            requiredFields.forEach(field => {
                if (field.type === 'checkbox' && !field.checked) {
                    isValid = false;
                    field.classList.add('border-red-500');
                    window.showNotification?.('Please agree to the Terms and Privacy Policy');
                } else if (!field.value) {
                    isValid = false;
                    field.classList.add('border-red-500');
                } else {
                    field.classList.remove('border-red-500');
                }
            });

            if (step === 3) {
                const householdSize = Number(document.getElementById('householdSize')?.value || 0);
                const minorsCount = Number(document.getElementById('minorsCount')?.value || 0);
                
                if (minorsCount > householdSize) {
                    window.showNotification?.('Number of children cannot exceed total household size');
                    document.getElementById('minorsCount')?.classList.add('border-red-500');
                    isValid = false;
                }
            }

            return isValid;
        }

        // Event Listeners
        document.querySelectorAll('.next-step').forEach(button => {
            button.addEventListener('click', () => {
                const step = parseInt(button.dataset.currentStep);
                if (validateStep(step)) {
                    currentStep = Math.min(step + 1, totalSteps);
                    updateStepVisibility();
                }
            });
        });

        document.querySelectorAll('.prev-step').forEach(button => {
            button.addEventListener('click', () => {
                const step = parseInt(button.dataset.currentStep);
                currentStep = Math.max(step - 1, 1);
                updateStepVisibility();
            });
        });

        // Handle assistance type change
        const assistanceSelect = document.getElementById('assistance');
        const foodOptions = document.getElementById('foodOptions');
        const otherSupportDetails = document.getElementById('otherSupportDetails');
        
        assistanceSelect?.addEventListener('change', (e) => {
            if (e.target.value === 'foodbox') {
                foodOptions?.classList.remove('hidden');
                otherSupportDetails?.classList.add('hidden');
            } else if (e.target.value === 'other') {
                otherSupportDetails?.classList.remove('hidden');
                foodOptions?.classList.add('hidden');
            } else {
                foodOptions?.classList.add('hidden');
                otherSupportDetails?.classList.add('hidden');
            }
        });

        // Initialize first step
        updateStepVisibility();

        const form = document.getElementById('multi-step-form');
        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                // Check if submission cookie exists
                if (document.cookie.split(';').some((item) => item.trim().startsWith('formSubmitted='))) {
                    alert('You have already submitted a request. Please wait 2-3 days before submitting another request.');
                    return;
                }

                if (validateStep(currentStep)) {
                    // Submit form to Formspree
                    const formData = new FormData(this);
                    fetch('https://formspree.io/f/mjkykawl', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'Accept': 'application/json'
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            // Set cookie to expire in 2 days
                            const d = new Date();
                            d.setTime(d.getTime() + (2 * 24 * 60 * 60 * 1000));
                            document.cookie = `formSubmitted=true;expires=${d.toUTCString()};path=/`;
                            // Show success message
                            window.location.href = '/thank-you';
                        } else {
                            // Show error message
                          //  alert('Oops! There was a problem submitting your form. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Oops! There was a problem submitting your form. Please try again.');
                    });
                }
            }, false);

            // Format phone number as user types
            const phoneInput = document.getElementById('phone');
            if (phoneInput) {
                phoneInput.addEventListener('input', (e) => {
                    // Remove all non-digits
                    let value = e.target.value.replace(/\D/g, '');
                    // Limit to 10 digits
                    value = value.substring(0, 10);
                    e.target.value = value;
                });
            }

            // Format household income as user types
            const incomeInput = document.getElementById('householdIncome');
            if (incomeInput) {
                incomeInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value) {
                        value = parseInt(value, 10);
                        e.target.value = value;
                    }
                });
            }
        }
    });
</script> 